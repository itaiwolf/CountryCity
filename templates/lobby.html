<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lobby - ארץ עיר</title>
    <link rel="stylesheet" href="/common.css">
</head>
<body>
    <!-- Modal for name input -->
    <div id="nameModal" class="modal">
        <div class="modal-content">
            <h2>Enter Your Name</h2>
            <input type="text" id="playerNameInput" placeholder="Your name" required>
            <button onclick="submitName()">Enter Lobby</button>
        </div>
    </div>

    <div class="container">
        <h1>Waiting for Players...</h1>

        <!-- Section for sharing game link and code -->
        <div id="friends-lobby">
            <p>Share this link or game code with your friends:</p>
            <button id="copyLinkButton" onclick="copyLink()">Copy Link</button>
            <button id="copyCodeButton" onclick="copyCode()">Copy Code</button>
        </div>

        <div id="lobby-status">
            <p>Players in lobby: <span id="player-count">1</span>/10</p>
            <p>The game will start once the host presses "Start Game".</p>
        </div>
        
        <!-- Section showing player list -->
        <div id="player-list-container">
            <h3>Players in the Lobby:</h3>
            <ul id="player-list"></ul> <!-- This will be populated with player names -->
        </div>
        
        <!-- Host control: Start and Cancel buttons (visible only to the host) -->
        <div id="host-controls" class="hidden">
            <button id="start-game-btn" onclick="startGame()">Start Game</button>
            <button id="cancel-game-btn" class="hidden" onclick="cancelGame()">Cancel</button>
        </div>

        <!-- Countdown -->
        <div id="countdown">Countdown: <span id="countdown-timer"></span> seconds remaining...</div>
    </div>

    <!-- Include Socket.io client script -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();  // Connect to Socket.io server
        let isHost = false;  // Assume the player is not the host by default
        let countdownInterval = null;  // To store countdown timer
        
        document.addEventListener('DOMContentLoaded', function () {
            showNameModal();  // Show the name modal as soon as the page loads
        });

        function showNameModal() {
            const modal = document.getElementById('nameModal');
            modal.style.display = 'block'; // Display the modal
        }

        function submitName() {
            const playerNameInput = document.getElementById('playerNameInput');
            const playerName = playerNameInput.value.trim();
            if (playerName) {
                localStorage.setItem('playerName', playerName);  // Store the player's name
                const modal = document.getElementById('nameModal');
                modal.style.display = 'none'; // Hide the modal once the name is submitted

                socket.emit('joinLobby', { playerName, gameCode: getLobbyParams() });
                joinLobby(playerName);  // Proceed to join the lobby
            } else {
                alert('Please enter a name.'); // Alert if no name is entered
            }
        }

        function joinLobby(playerName) {
            // Emit event to join the lobby, or perform AJAX call as needed
            console.log('Joining lobby with name:', playerName);
            // Additional Socket.io or AJAX code to actually join the lobby goes here
        }

        function getLobbyParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('code');
        }

        function copyLink() {
            const link = `${window.location.href}`;
            navigator.clipboard.writeText(link).then(() => {
                const button = document.getElementById('copyLinkButton');
                button.textContent = 'Link Copied';
                setTimeout(() => {
                    button.textContent = 'Copy Link';
                }, 5000);  // Reset text after 5 seconds
            }).catch(err => console.error('Failed to copy:', err));
        }

        function copyCode() {
            const code = getLobbyParams();
            navigator.clipboard.writeText(code).then(() => {
                const button = document.getElementById('copyCodeButton');
                button.textContent = 'Code Copied';
                setTimeout(() => {
                    button.textContent = 'Copy Code';
                }, 5000);  // Reset text after 5 seconds
            }).catch(err => console.error('Failed to copy:', err));
        }

        function setupLobbyPage() {
            const gameCode = getLobbyParams();
    
            if (!gameCode) {
                alert('No game code found. Redirecting to the homepage.');
                window.location.href = '/index.html';
                return;
            }

             // Listen for updates on player count
            socket.on('updatePlayerCount', (playerCount) => {
                const playerCountElement = document.getElementById('player-count');
                if (playerCountElement) {
                    playerCountElement.textContent = `${playerCount}`;
                } else {
                    console.error('Player count element not found');
                }
            });

            socket.on('updatePlayerList', (players) => {
                const playerListElement = document.getElementById('player-list');
                playerListElement.innerHTML = '';  // Clear the list before updating

                players.forEach(playerName => {
                    const li = document.createElement('li');
                    li.textContent = playerName;
                    playerListElement.appendChild(li);
                });
            });

            socket.on('isHost', (isHostPlayer) => {
                if (isHostPlayer) {
                    isHost = true;
                    document.getElementById('host-controls').classList.remove('hidden');
                }
            });

            socket.on('startCountdown', (countdown) => {
                document.getElementById('countdown').classList.add('show');
                startCountdown(countdown);
            });

            socket.on('cancelCountdown', () => {
                clearInterval(countdownInterval);
                document.getElementById('countdown').classList.remove('show');
                document.getElementById('cancel-game-btn').classList.add('hidden');
            });

            socket.on('redirectToGame', () => {
                window.location.href = 'play.html';
            });
        }

        function startGame() {
            if (isHost) {
                socket.emit('startGame');
                document.getElementById('start-game-btn').classList.add('hidden');
                document.getElementById('cancel-game-btn').classList.remove('hidden');
            } else {
                alert('Only the host can start the game.');
            }
        }

    
        // Function to start the countdown on the client side
        function startCountdown(countdown = 5) {  // Start from the provided countdown
            document.getElementById('countdown-timer').textContent = countdown;
    
            // Clear any previous countdown
            clearInterval(countdownInterval);
    
            countdownInterval = setInterval(() => {
                countdown--;
                document.getElementById('countdown-timer').textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    // Redirect all players to the game page (play.html) after countdown ends
                    window.location.href = 'play.html';
                }
            }, 1000);
        }
    
        // Function to cancel the game
        function cancelGame() {
            if (isHost) {
                socket.emit('cancelGame');  // Emit the cancelGame event to the server
                document.getElementById('cancel-game-btn').classList.add('hidden');
                document.getElementById('start-game-btn').classList.remove('hidden');
            }
        }
    
        document.addEventListener('DOMContentLoaded', function () {
            // Get player name from localStorage
            const playerName = localStorage.getItem('playerName');
            
            if (playerName) {
                // Set up the lobby page once the player name is confirmed
                setupLobbyPage();
            } else {
                // If no player name, redirect back to index
                window.location.href = '/index.html';
            }
        });

        document.getElementById('playerNameInput').addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent the default action to avoid form submission or any other unwanted behavior
                submitName(); // Directly call the submitName function when Enter is pressed
            }
        });


    </script>
    
</body>
</html>
